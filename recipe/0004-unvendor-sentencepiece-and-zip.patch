From 4c27f05595d657ba1d27f6bdaeff8d0ca81e04ae Mon Sep 17 00:00:00 2001
From: Jack Olivieri <jolivieri@anaconda.com>
Date: Wed, 9 Oct 2024 09:40:04 +0200
Subject: [PATCH 4/4] unvendor-sentencepiece and zip

---
 fairseq2n/CMakeLists.txt                                    | 2 +-
 fairseq2n/src/fairseq2n/CMakeLists.txt                      | 6 +++++-
 .../src/fairseq2n/data/text/sentencepiece/sp_processor.cc   | 2 +-
 .../src/fairseq2n/data/text/sentencepiece/sp_processor.h    | 2 +-
 4 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/fairseq2n/CMakeLists.txt b/fairseq2n/CMakeLists.txt
index 18112406..2c17461c 100644
--- a/fairseq2n/CMakeLists.txt
+++ b/fairseq2n/CMakeLists.txt
@@ -194,7 +194,7 @@ fairseq2n_add_kaldi_native_fbank()
 
 fairseq2n_add_natsort()
 
-fairseq2n_add_sentencepiece()
+# fairseq2n_add_sentencepiece()
 
 fairseq2n_add_zip()
 
diff --git a/fairseq2n/src/fairseq2n/CMakeLists.txt b/fairseq2n/src/fairseq2n/CMakeLists.txt
index 8e959e9f..046c3eef 100644
--- a/fairseq2n/src/fairseq2n/CMakeLists.txt
+++ b/fairseq2n/src/fairseq2n/CMakeLists.txt
@@ -102,6 +102,9 @@ target_include_directories(fairseq2n ${system}
         $<BUILD_INTERFACE:${PROJECT_BINARY_DIR}/src>
 )
 
+target_include_directories(fairseq2n PRIVATE $ENV{PREFIX}/include)
+target_include_directories(fairseq2n PRIVATE $ENV{SRC_DIR}/fairseq2n/third-party)
+
 target_link_libraries(fairseq2n
     PRIVATE
         ${CMAKE_DL_LIBS}
@@ -112,7 +115,8 @@ target_link_libraries(fairseq2n
         kuba-zip
         natsort
         Threads::Threads
-        sentencepiece-static
+        sentencepiece
+        protobuf
         SndFile::sndfile
     PUBLIC
         torch
diff --git a/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.cc b/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.cc
index 1792fc23..73f4af01 100644
--- a/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.cc
+++ b/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.cc
@@ -10,7 +10,7 @@
 #include <system_error>
 
 #include <fmt/format.h>
-#include <sentencepiece/src/builtin_pb/sentencepiece_model.pb.h>
+#include "sentencepiece_model.pb.h"
 
 #include "fairseq2n/detail/exception.h"
 #include "fairseq2n/utils/cast.h"
diff --git a/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.h b/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.h
index 634ce8cb..bafd9deb 100644
--- a/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.h
+++ b/fairseq2n/src/fairseq2n/data/text/sentencepiece/sp_processor.h
@@ -13,7 +13,7 @@
 #include <string_view>
 #include <vector>
 
-#include <sentencepiece/src/sentencepiece_processor.h>
+#include "sentencepiece_processor.h"
 
 #include "fairseq2n/data/text/sentencepiece/sp_model.h"
 
-- 
2.39.5 (Apple Git-154)

